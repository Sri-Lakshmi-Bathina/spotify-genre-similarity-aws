Run Query #1: Row counts
SELECT 'raw_tracks' AS table_name, count(*) AS row_count
FROM spotify_similarity_db.raw_tracks
UNION ALL
SELECT 'raw_artists' AS table_name, count(*) AS row_count
FROM spotify_similarity_db.raw_artists;

Result: 1104349, 586672

Run Query #2: Confirm key columns exist
SELECT
  id,
  name,
  popularity,
  danceability,
  energy,
  tempo
FROM spotify_similarity_db.raw_tracks
LIMIT 5;

Result: # id name popularity danceability energy tempo # id name popularity danceability energy tempo 1 5NNDgSIV4DQsuuXr8YuPRl She Takes Her Clothes Off 32 0.521 0.571 109.071

Run Query #3: Artists schema check
SELECT
  id,
  name,
  popularity,
  genres
FROM spotify_similarity_db.raw_artists
LIMIT 5;

Result: #
id
name
popularity
genres
#
id
name
popularity
genres
1
37onzqJBkJlZvc1u8jHlk4
The Royal Chopin Orquesta
0
[]
2
3SaHb7FQ6C4BjtHtB0ocjd
Csilla Szabó
1
['hungarian classical piano']

Query A — row count
SELECT count(*) AS curated_rows
FROM spotify_similarity_db.curated_tracks_by_genre;

Result: 1561952

Query B — top genres
SELECT genre, count(*) AS n
FROM spotify_similarity_db.curated_tracks_by_genre
GROUP BY genre
ORDER BY n DESC
LIMIT 20;

Result: 1 rock 30777 2 classic rock 22760 3 adult standards 22613 4 mellow gold 18221 5 album rock 17015 6 soft rock 16292 7 folk rock 14496 8 art rock 12126 9 latin 11440 10 hard rock 11392 11 vocal jazz 11365 12 soul 11318 13 lounge 10996 14 country rock 10744 15 hoerspiel 10448 16 filmi 9982 17 brill building pop 9519 18 rock en espanol 9395 19 latin pop 9153 20 jazz 8868

Query:
SHOW TABLES;
Result:
curated_tracks_by_genre 
raw_artists 
raw_tracks

Query A — check row count

SELECT count(*) AS predictor_rows
FROM spotify_similarity_db.results_genre_predictors;
result: 225

Query B — top predictors for one genre

SELECT feature, importance_norm
FROM spotify_similarity_db.results_genre_predictors
WHERE genre = 'rock'
ORDER BY importance_norm DESC
LIMIT 10;
Result: # feature importance_norm # feature importance_norm 1 tempo 0.6219626562197715 2 loudness 0.31646457276980755 3 energy 0.014930527359261921 4 acousticness 0.013604928196098473 5 valence 0.013544765948411487 6 danceability 0.008177765880641093 7 instrumentalness 0.007613830325368528 8 liveness 0.0022860065397881427 9 speechiness 0.0014149467608512779

Query: Validate in Athena
SELECT genre, n_queries, k, recall_at_k, mrr_at_k, run_ts
FROM spotify_similarity_db.results_eval_audio_similarity
ORDER BY recall_at_k DESC
LIMIT 20;
Results: . # genre n_queries k recall_at_k mrr_at_k run_ts # genre n_queries k recall_at_k mrr_at_k run_ts 1 hoerspiel 150 10 0.8066666666666666 0.5121031746031746 2026-01-02 21:25:56.885 2 vocal jazz 150 10 0.2866666666666667 0.13739682539682538 2026-01-02 21:25:56.885 3 lounge 150 10 0.24666666666666667 0.08057936507936508 2026-01-02 21:25:56.885 4 latin 150 10 0.23333333333333334 0.11982804232804233 2026-01-02 21:25:56.885 5 hard rock 150 10 0.22 0.10962962962962959 2026-01-02 21:25:56.885

Query: Run this Athena query (CTAS to CSV with header
UNLOAD (
  WITH base AS (
    SELECT
      id AS track_id,
      name AS track_name,
      artist_name_primary,
      genre,
      rand() AS r
    FROM spotify_similarity_db.curated_tracks_by_genre
    WHERE genre IN (
      'rock','classic rock','adult standards','mellow gold','album rock',
      'soft rock','folk rock','art rock','latin','hard rock'
    )
    AND artist_name_primary IS NOT NULL
    AND name IS NOT NULL
  ),
  dedup AS (
    SELECT
      track_id, track_name, artist_name_primary, genre,
      row_number() OVER (PARTITION BY track_id ORDER BY r) AS rn
    FROM base
  )
  SELECT
    track_id,
    track_name,
    artist_name_primary,
    genre
  FROM dedup
  WHERE rn = 1
  LIMIT 800
)
TO 's3://spotify-genre-similarity-sri/curated/lyrics_input_header/'
WITH (
  format = 'TEXTFILE',
  field_delimiter = ',',
  compression = 'NONE'
);

dd a header row (small S3 Console action)
Because Athena still won’t add headers automatically, we’ll do the simplest beginner-safe approach:
Open the file you just created under curated/lyrics_input_header/ in S3 (it will be a single text file)
Click Download
Open locally in a text editor (or Excel), then add this as the first line:
track_id,track_name,artist_name_primary,genre
Save the file as lyrics_input.csv
Upload it back to:
s3://spotify-genre-similarity-sri/curated/lyrics_input_header/lyrics_input.csv

Query A — confirm lyrics row count
SELECT
  count(*) AS lyric_rows,
  sum(CASE WHEN lyrics_found THEN 1 ELSE 0 END) AS found_rows
FROM spotify_similarity_db.curated_lyrics_by_track_sample_parquet;
Results: # lyric_rows found_rows # lyric_rows found_rows 1 800 765

Query B — join coverage with curated tracks
SELECT
  t.genre,
  count(*) AS track_rows_in_genre,
  count(l.track_id) AS tracks_with_lyrics
FROM spotify_similarity_db.curated_tracks_by_genre t
LEFT JOIN spotify_similarity_db.curated_lyrics_by_track_sample_parquet l
  ON t.id = l.track_id
WHERE t.genre IN ('rock','latin','hard rock','vocal jazz')
GROUP BY t.genre
ORDER BY track_rows_in_genre DESC;
Results: # genre track_rows_in_genre tracks_with_lyrics # genre track_rows_in_genre tracks_with_lyrics 1 rock 30777 0 2 latin 11440 800 3 hard rock 11392 0 4 vocal jazz 11365 0

Query A — What genres are present in the lyrics table itself?
SELECT genre, count(*) AS n
FROM spotify_similarity_db.curated_lyrics_by_track_sample_parquet
GROUP BY genre
ORDER BY n DESC;
Result: # genre n # genre n 1 latin 783 2 soft rock 2 3 ov7 1 4 jarabe de palo 1 5 josé luis perales 1 6 grupo niche 1 7 daniela romo 1 8 yahir 1 9 amor) 1 10 los enanitos verdes 1 11 camilo sesto 1 12 dlg 1 13 karol g 1 14 julio iglesias 1 15 alejandro sanz 1 16 shakira 1 17 alejandro fernández 1

Query B — For those 800 track_ids, which genres do they map to in the curated tracks table?
SELECT
  t.genre,
  count(DISTINCT t.id) AS distinct_tracks_with_lyrics
FROM spotify_similarity_db.curated_tracks_by_genre t
JOIN spotify_similarity_db.curated_lyrics_by_track_sample_parquet l
  ON t.id = l.track_id
GROUP BY t.genre
ORDER BY distinct_tracks_with_lyrics DESC
LIMIT 25;
Result: # genre distinct_tracks_with_lyrics # genre distinct_tracks_with_lyrics 1 latin 800 2 latin pop 479 3 tropical 364 4 reggaeton 155 5 trap latino 142 6 mexican pop 127 7 ranchera 116 8 rock en espanol 111 9 latin arena pop 106 10 salsa 102 11 latin hip hop 101 12 dominican pop 70 13 salsa puertorriquena 65 14 bachata 62 15 regional mexican 57 16 spanish pop 57 17 latin alternative 51 18 latin rock 49 19 bachata dominicana 48 20 merengue 43 21 mariachi 42 22 dance pop 42 23 colombian pop 40 24 reggaeton colombiano 38 25 cancion melodica 3

Regenerate a stratified lyrics input file (80 tracks per genre, 10 genres)
13.9.1 Create a new S3 folder

In S3 create:
curated/lyrics_input_stratified/

13.9.2 Run this Athena query to export stratified rows
In Athena (database spotify_similarity_db), run:

UNLOAD (
  WITH ranked AS (
    SELECT
      id AS track_id,
      name AS track_name,
      artist_name_primary,
      genre,
      row_number() OVER (PARTITION BY genre ORDER BY rand()) AS rn
    FROM spotify_similarity_db.curated_tracks_by_genre
    WHERE genre IN (
      'rock','classic rock','adult standards','mellow gold','album rock',
      'soft rock','folk rock','art rock','latin','hard rock'
    )
    AND artist_name_primary IS NOT NULL
    AND name IS NOT NULL
  )
  SELECT track_id, track_name, artist_name_primary, genre
  FROM ranked
  WHERE rn <= 80
)
TO 's3://spotify-genre-similarity-sri/curated/lyrics_input_stratified/'
WITH (
  format = 'TEXTFILE',
  field_delimiter = ',',
  compression = 'NONE'
);

Create a headered file for the job (same as before)
In S3 → curated/lyrics_input_stratified/ download the generated UNLOAD file
Add this header as the first line:
track_id,track_name,artist_name_primary,genre
Save as lyrics_input_stratified.csv
Upload back to: s3://spotify-genre-similarity-sri/curated/lyrics_input_stratified/lyrics_input_stratified.csv

Query: Validate genre distribution in Athena
Run this in Athena (db: spotify_similarity_db):
SELECT genre, count(*) AS n, sum(CASE WHEN lyrics_found THEN 1 ELSE 0 END) AS found
FROM spotify_similarity_db.curated_lyrics_by_track_sample_parquet
GROUP BY genre
ORDER BY n DESC;

Re-crawl the Parquet lyrics dataset and validate distribution in Athena
Query A — genre distribution
SELECT genre, count(*) AS n, sum(CASE WHEN lyrics_found THEN 1 ELSE 0 END) AS found
FROM spotify_similarity_db.curated_lyrics_by_track_sample_parquet
GROUP BY genre
ORDER BY n DESC;
Output:# genre n found # genre n found 1 rock 76 74 2 mellow gold 73 70 3 art rock 39 37 4 stills 2 2 5 paul and mary 1 1 6 the kinks 1 1 7 the rolling stones 1 1 8 peter gabriel 1 0 9 sweat & tears 1 1 10 stills & nash 1 1 11 august 1980 1 0 12 dc 1 0 13 pink floyd 1 0 14 ny - june 1977 1 1

Query B — join coverage for the 10 target genres
SELECT
  t.genre,
  count(DISTINCT t.id) AS tracks_in_curated,
  count(DISTINCT l.track_id) AS tracks_with_lyrics
FROM spotify_similarity_db.curated_tracks_by_genre t
LEFT JOIN spotify_similarity_db.curated_lyrics_by_track_sample_parquet l
  ON t.id = l.track_id
WHERE t.genre IN (
  'rock','classic rock','adult standards','mellow gold','album rock',
  'soft rock','folk rock','art rock','latin','hard rock'
)
GROUP BY t.genre
ORDER BY tracks_with_lyrics DESC;
Result: # genre tracks_in_curated tracks_with_lyrics # genre tracks_in_curated tracks_with_lyrics 1 rock 30777 163 2 classic rock 22760 133 3 mellow gold 18221 118 4 album rock 17015 100 5 soft rock 16292 93 6 art rock 12126 82 7 folk rock 14496 79 8 hard rock 11392 49 9 adult standards 22613 13 10 latin 11440 0

Query:Run this Athena query to generate a safe CSV (quoted)
UNLOAD (
  WITH ranked AS (
    SELECT
      id AS track_id,
      name AS track_name,
      artist_name_primary,
      genre,
      row_number() OVER (PARTITION BY genre ORDER BY rand()) AS rn
    FROM spotify_similarity_db.curated_tracks_by_genre
    WHERE genre IN (
      'rock','classic rock','adult standards','mellow gold','album rock',
      'soft rock','folk rock','art rock','latin','hard rock'
    )
    AND artist_name_primary IS NOT NULL
    AND name IS NOT NULL
  )
  SELECT
    track_id,
    track_name,
    artist_name_primary,
    genre
  FROM ranked
  WHERE rn <= 80
)
TO 's3://spotify-genre-similarity-sri/curated/lyrics_input_stratified_safe/'
WITH (
  format = 'TEXTFILE',
  field_delimiter = ',',
  compression = 'NONE'
);

Query: Validate genres are clean in Athena
SELECT genre, count(*) AS n, sum(CASE WHEN lyrics_found THEN 1 ELSE 0 END) AS found
FROM spotify_similarity_db.curated_lyrics_by_track_sample_parquet
GROUP BY genre
ORDER BY n DESC;
Result: # genre n found # genre n found 1 rock 79 74 2 art rock 77 66 3 adult standards 37 26 4 pink floyd 2 2 5 robert palmer 1 1 6 the smashing pumpkins 1 1 7 ray conniff 1 1 8 harry belafonte 1 1 9 jerry vale 1 1

Query A — ensure genres look correct
SELECT genre, count(*) AS n
FROM spotify_similarity_db.curated_lyrics_enriched_by_genre
GROUP BY genre
ORDER BY n DESC;
Result: # genre n # genre n 1 rock 136 2 art rock 107 3 classic rock 94 4 album rock 73 5 mellow gold 51 6 hard rock 45 7 symphonic rock 44 8 adult standards 43 9 psychedelic rock 42 10 soft rock 41 11 folk rock 38 12 progressive rock 36 13 permanent wave 28 14 alternative rock 28 15 blues rock 25 16 country rock 23 17 glam rock 22 18 new wave pop 20 19 roots rock 20 20 lounge 20 21 new wave 19 22 brill building pop 19 23 vocal jazz 17 24 folk 17 25 british invasion 17 26 metal 15 27 beatlesque 14 28 new romantic 13 29 easy listening 13 30 classic uk pop 12 31 jazz fusion 11 32 post-punk 11 33 singer-songwriter 9 34 rock-and-roll 9 35 pop rock 9 36 heartland rock 8 37 yacht rock 8 38 melancholia 8 39 swing 8 40 alternative metal 8 41 soul 7 42 uk post-punk 7 43 zolo 7 44 indie rock 7 45 glam metal 7 46 pub rock 7 47 power pop 7 48 modern rock 7 49 merseybeat 6 50 funk rock 6 51 british blues 5 52 punk 5 53 art pop 5 54 bubblegum pop 5 55 sophisti-pop 5 56 torch song 5 57 flute rock 5 58 funk metal 5 59 dream pop 5 60 experimental 5 61 shoegaze 4 62 motown 4 63 quiet storm 4 64 jazz blues 4 65 nu gaze 4 66 bow pop 4 67 noise pop 4 68 nu metal 4 69 rockabilly 4 70 disco 4 71 neo classical metal 3 72 jazz funk 3 73 protopunk 3 74 post-grunge 3 75 instrumental rock 3 76 jangle pop 3 77 rap rock 3 78 dance rock 3 79 art punk 3 80 irish rock 3 81 funk 3 82 power metal 3 83 early us punk 3 84 skate punk 3 85 grunge 3 86 boston rock 2 87 british folk 2 88 vocal harmony group 2 89 scottish rock 2 90 jazz violin 2 91 french jazz 2 92 german rock 2 93 psychedelic folk 2 94 piano rock 2 95 swedish hard rock 2 96 cosmic american 2 97 new age 2 98 jam band 2 99 synthpop 2 100 harlem renaissance 2

Query B — sanity join count
SELECT count(DISTINCT track_id) AS distinct_tracks
FROM spotify_similarity_db.curated_lyrics_enriched_by_genre;
Result: # distinct_tracks # distinct_tracks 1 200

Query A — Show Audio+Lyrics results (top by recall)
SELECT genre, recall_at_k, mrr_at_k, alpha_audio_weight, n_queries, n_tracks_in_genre, run_ts
FROM spotify_similarity_db.results_eval_audio_lyrics_similarity
ORDER BY recall_at_k DESC
LIMIT 20;
Result: # genre recall_at_k mrr_at_k alpha_audio_weight n_queries n_tracks_in_genre run_ts # genre recall_at_k mrr_at_k alpha_audio_weight n_queries n_tracks_in_genre run_ts 1 psychedelic rock 0.4166666666666667 0.20231481481481478 0.8 36 36 2026-01-04 05:26:36.140 2 symphonic rock 0.37142857142857144 0.13482993197278909 0.8 35 35 2026-01-04 05:26:36.140 3 classic rock 0.16279069767441862 0.08856589147286821 0.8 86 86 2026-01-04 05:26:36.140 4 art rock 0.14736842105263157 0.09713450292397662 0.8 95 95 2026-01-04 05:26:36.140 5 folk rock 0.1388888888888889 0.015509259259259259 0.8 36 36 2026-01-04 05:26:36

Query B — Side-by-side comparison with deltas (Audio+Lyrics minus Audio-only)
WITH a AS (
  SELECT genre, recall_at_k AS recall_audio, mrr_at_k AS mrr_audio
  FROM spotify_similarity_db.results_eval_audio_similarity
),
al AS (
  SELECT genre, recall_at_k AS recall_audio_lyrics, mrr_at_k AS mrr_audio_lyrics, alpha_audio_weight
  FROM spotify_similarity_db.results_eval_audio_lyrics_similarity
)
SELECT
  al.genre,
  recall_audio,
  recall_audio_lyrics,
  (recall_audio_lyrics - recall_audio) AS delta_recall,
  mrr_audio,
  mrr_audio_lyrics,
  (mrr_audio_lyrics - mrr_audio) AS delta_mrr,
  alpha_audio_weight
FROM al
LEFT JOIN a ON a.genre = al.genre
ORDER BY delta_recall DESC
LIMIT 50;
Result: # genre recall_audio recall_audio_lyrics delta_recall mrr_audio mrr_audio_lyrics delta_mrr alpha_audio_weight # genre recall_audio recall_audio_lyrics delta_recall mrr_audio mrr_audio_lyrics delta_mrr alpha_audio_weight 1 folk rock 0.11333333333333333 0.1388888888888889 0.025555555555555567 0.04367195767195767 0.015509259259259259 -0.02816269841269841 0.8 2 classic rock 0.16666666666666666 0.16279069767441862 -0.003875968992248041 0.07403439153439152 0.08856589147286821 0.014531499938476689 0.8 3 art rock 0.18666666666666668 0.14736842105263157 -0.03929824561403511 0.09933333333333333 0.09713450292397662 -0.002198830409356714 0.8 4 soft rock 0.13333333333333333 0.08333333333333333 -0.05 0.07690476190476189 0.019290123456790122 -0.05761463844797177 0.8 5 rock 0.18666666666666668 0.13 -0.05666666666666667 0.08531216931216931 0.06453968253968254 -0.020772486772486776 0.8 6 mellow gold 0.15333333333333332 0.06521739130434782 -0.0881159420289855 0.06797089947089947 0.00914423740510697 -0.058826662065792505 0.8 7 album rock 0.22 0.12698412698412698 -0.09301587301587302 0.110026455026455 0.06106701940035274 -0.04895943562610226 0.8 8 hard rock 0.22 0.09523809523809523 -0.12476190476190477 0.10962962962962959 0.01808390022675737 -0.09154572940287223 0.8 9 symphonic rock 0.37142857142857144 0.13482993197278909 0.8 10 psychedelic rock 0.4166666666666667 0.20231481481481478 0.8

Query C — Create a reusable “delta” table in Athena (optional but recommended for QuickSight)
CREATE TABLE IF NOT EXISTS spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics
WITH (
  format = 'PARQUET',
  external_location = 's3://spotify-genre-similarity-sri/results/eval_delta_audio_vs_audio_lyrics/',
  partitioned_by = ARRAY['genre']
) AS
WITH a AS (
  SELECT genre, recall_at_k AS recall_audio, mrr_at_k AS mrr_audio
  FROM spotify_similarity_db.results_eval_audio_similarity
),
al AS (
  SELECT genre, recall_at_k AS recall_audio_lyrics, mrr_at_k AS mrr_audio_lyrics, alpha_audio_weight
  FROM spotify_similarity_db.results_eval_audio_lyrics_similarity
)
SELECT
  al.genre,
  recall_audio,
  recall_audio_lyrics,
  (recall_audio_lyrics - recall_audio) AS delta_recall,
  mrr_audio,
  mrr_audio_lyrics,
  (mrr_audio_lyrics - mrr_audio) AS delta_mrr,
  alpha_audio_weight
FROM al
LEFT JOIN a ON a.genre = al.genre;
Result: HIVE_COLUMN_ORDER_MISMATCH: Partition keys must be the last columns in the table and in the same order as the table properties: [genre]. You may need to manually clean the data at location 's3://spotify-genre-similarity-sri/athena-query-results/Unsaved/2026/01/04/tables/f33c5cd5-2ca5-4070-9619-e81a54ea149e' before retrying. Athena will not delete data in your account. This query ran against the "spotify_similarity_db" database, unless qualified by the query. Please post the error message on our forum or contact customer support with Query Id: f33c5cd5-2ca5-4070-9619-e81a54ea149e

Fix Query C (and clean up the failed CTAS output)
A) Delete the failed CTAS output folder (one-time cleanup)

Go to S3 → your Athena results bucket path shown in the error and delete that folder:

s3://spotify-genre-similarity-sri/athena-query-results/Unsaved/2026/01/04/tables/f33c5cd5-2ca5-4070-9619-e81a54ea149e/

(If you don’t delete it, Athena won’t overwrite it later.)

B) Re-run CTAS with genre as the last column

Run this in Athena (db: spotify_similarity_db):

DROP TABLE IF EXISTS spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics;


Now run the corrected CTAS (partitioned, with genre last):

CREATE TABLE spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics
WITH (
  format = 'PARQUET',
  external_location = 's3://spotify-genre-similarity-sri/results/eval_delta_audio_vs_audio_lyrics/',
  partitioned_by = ARRAY['genre']
) AS
WITH a AS (
  SELECT genre, recall_at_k AS recall_audio, mrr_at_k AS mrr_audio
  FROM spotify_similarity_db.results_eval_audio_similarity
),
al AS (
  SELECT genre, recall_at_k AS recall_audio_lyrics, mrr_at_k AS mrr_audio_lyrics, alpha_audio_weight
  FROM spotify_similarity_db.results_eval_audio_lyrics_similarity
)
SELECT
  recall_audio,
  recall_audio_lyrics,
  (recall_audio_lyrics - recall_audio) AS delta_recall,
  mrr_audio,
  mrr_audio_lyrics,
  (mrr_audio_lyrics - mrr_audio) AS delta_mrr,
  alpha_audio_weight,
  al.genre
FROM al
LEFT JOIN a ON a.genre = al.genre;

C) Repair partitions (so Athena “sees” them)
MSCK REPAIR TABLE spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics;

SELECT genre, delta_recall, delta_mrr, alpha_audio_weight
FROM spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics
ORDER BY delta_recall DESC
LIMIT 10;
Result: # genre delta_recall delta_mrr alpha_audio_weight # genre delta_recall delta_mrr alpha_audio_weight 1 folk rock 0.025555555555555567 -0.02816269841269841 0.8 2 classic rock -0.003875968992248041 0.014531499938476689 0.8 3 art rock -0.03929824561403511 -0.002198830409356714 0.8 4 soft rock -0.05 -0.05761463844797177 0.8 5 rock -0.05666666666666667 -0.020772486772486776 0.8 6 mellow gold -0.0881159420289855 -0.058826662065792505 0.8 7 album rock -0.09301587301587302 -0.04895943562610226 0.8 8 hard rock -0.12476190476190477 -0.09154572940287223 0.8 9 psychedelic rock 0.8 10 symphonic rock 0.8

we keep all genres and explicitly flag whether the audio-only baseline exists, so QuickSight can show (and you can optionally filter) the “baseline missing” cases.

Step 14.6 — Create a flagged delta table in Athena (baseline-aware)
14.6.1 Create the flagged delta table (CTAS)

Run this in Athena (db: spotify_similarity_db). This keeps genre last (required for partitioning):

DROP TABLE IF EXISTS spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics_flagged;


CREATE TABLE spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics_flagged
WITH (
  format = 'PARQUET',
  external_location = 's3://spotify-genre-similarity-sri/results/eval_delta_audio_vs_audio_lyrics_flagged/',
  partitioned_by = ARRAY['genre']
) AS
WITH a AS (
  SELECT genre, recall_at_k AS recall_audio, mrr_at_k AS mrr_audio
  FROM spotify_similarity_db.results_eval_audio_similarity
),
al AS (
  SELECT genre, recall_at_k AS recall_audio_lyrics, mrr_at_k AS mrr_audio_lyrics, alpha_audio_weight
  FROM spotify_similarity_db.results_eval_audio_lyrics_similarity
)
SELECT
  CASE WHEN a.genre IS NULL THEN 0 ELSE 1 END AS baseline_available,
  a.recall_audio,
  al.recall_audio_lyrics,
  CASE WHEN a.genre IS NULL THEN NULL ELSE (al.recall_audio_lyrics - a.recall_audio) END AS delta_recall,
  a.mrr_audio,
  al.mrr_audio_lyrics,
  CASE WHEN a.genre IS NULL THEN NULL ELSE (al.mrr_audio_lyrics - a.mrr_audio) END AS delta_mrr,
  al.alpha_audio_weight,
  al.genre
FROM al
LEFT JOIN a ON a.genre = al.genre;

MSCK REPAIR TABLE spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics_flagged;

SELECT genre, baseline_available, delta_recall, delta_mrr
FROM spotify_similarity_db.results_eval_delta_audio_vs_audio_lyrics_flagged
ORDER BY baseline_available ASC, genre
LIMIT 20;
